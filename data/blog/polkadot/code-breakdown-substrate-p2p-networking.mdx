---
title: 'Code Breakdown @ Substrate P2P Networking'
date: '2023-11-28'
authors: ['1-tin-chung']
tags: ['technical', 'blockchain', 'polkadot', 'substrate', 'code-breakdown', 'lang-vn']
draft: false
summary: SÆ¡ lÆ°á»£c vá» kiáº¿n trÃºc máº¡ng ngang hÃ ng cá»§a Substrate Node vÃ  má»™t sá»‘ cÆ¡ cháº¿ tÃ¬m cÃ¡c node ngang hÃ ng trong cÃ¹ng má»™t máº¡ng lÆ°á»›i.
---

# Code Breakdown @ Substrate P2P Networking

## YÃªu cáº§u

- [Code Breakdown @ Substrate Node](https://lowlevelers.com/blog/polkadot/code-breakdown-substrate-node)

## BÃ i viáº¿t liÃªn quan

- [Crate `sc_network` documentation](https://paritytech.github.io/polkadot-sdk/master/sc_network/index.html)
- [Introduction to libp2p - Proto School](https://proto.school/introduction-to-libp2p/01)
- [Why libp2p? - Parity Technologies](https://www.parity.io/blog/why-libp2p)

## KhÃ¡i quÃ¡t kiáº¿n trÃºc máº¡ng cá»§a Polkadot

VÃ¬ theo Ä‘Ãºng tÃ­nh cháº¥t cá»§a má»™t máº¡ng phi táº­p trung, Polkadot khÃ´ng phá»¥ thuá»™c vÃ o báº¥t ká»³ **Central Authoriy (CA)** hoáº·c báº¥t ká»³ tá»‘ chá»©c nÃ o vÃ¢n hÃ nh vÃ  hoáº¡t Ä‘á»™ng. Giao thá»©c máº¡ng cá»§a Polkadot Ä‘Æ°á»£c Ä‘á»±a trÃªn táº­p há»£p cÃ¡c giao thá»©c má»Ÿ, bao gá»“m cáº£ nhá»¯ng giao thá»©c sá»­ dá»¥ng `libp2p` lÃ m ná»n táº£ng.

- `libp2p`: [**Lip2p**](https://libp2p.io/implementations/) lÃ  táº­p há»£p cÃ¡c thÆ° viá»‡n, giao thá»©c vÃ  cÃ´ng cá»¥ Ä‘á»ƒ xÃ¢y dá»±ng giao tiáº¿p cá»§a má»™t substrate node vá»›i cÃ¡c node trong cÃ¹ng há»‡ sinh thÃ¡i. MÃ¬nh sáº½ cÃ³ má»™t bÃ i phÃ¢n tÃ­ch cÃ´ng nghá»‡ vÃ  mÃ£ nguá»“n **libp2p** sÃ¢u hÆ¡n.
- `libp2p`: [Polkadot Host](https://wiki.polkadot.network/docs/learn-polkadot-host) sá»­ dá»¥ng há»‡ thá»‘ng addressing cá»§a `libp2p` Ä‘á»ƒ xÃ¡c Ä‘á»‹nh vÃ  káº¿t ná»‘i vá»›i cÃ¡c node ngang hÃ ng khÃ¡c

> Polkadot Host hay cÃ²n Ä‘Æ°á»£c xem lÃ  Polkadot Runtime Environment. Má»™t layer tháº¥p hÆ¡n cá»§a Polkadot Runtime vÃ  cung cáº¥p nhá»¯ng chá»©c nÄƒng cáº§n thiáº¿t Ä‘á»ƒ Polkadot Runtime hoÃ n thÃ nh nhiá»‡m vá»¥ chuyá»ƒn Ä‘á»•i tráº¡ng thÃ¡i cá»§a toÃ n chain (state transition logic.

- `Kademlia`: Kademila lÃ  distributed hash table thiáº¿t káº¿ cho máº¡ng ngang hÃ ng phi táº­p trung. Polkadot Host sá»­ dá»¥ng _Kademila_ trong **peer discovery.**
- [Noise](https://noiseprotocol.org/): Giao thá»©c `Noise` lÃ  framework Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ xÃ¢y dá»±ng cÃ¡c giao thá»©c máº­t mÃ£ há»c (cryptographic protocols). Polkadot Host sá»­ dá»¥ng Noise Ä‘á»ƒ thiÃªt láº­p cÃ¡c lá»›p mÃ£ hoÃ¡ tá»›i cÃ¡c **remote peers**.
- `yamux`: yamux lÃ  má»™t multiplexing protocol.

> Multiplexing Protocol: Giao thá»©c ghÃ©p kÃªnh lÃ  quÃ¡ trÃ¬nh nhiá»u tÃ­n hiá»‡u thÃ nh má»™t tÃ­n hiá»‡u dá»… Ä‘á»ƒ truyá»n Ä‘i xa

- `Protocol Buffers`: Náº¿u báº¡n Ä‘Ã£ tá»«ng lÃ m viá»‡c vá»›i `gRPC` thÃ¬ cháº¯c báº¡n cÅ©ng khÃ´ng cÃ²n láº¡ láº§m gÃ¬ vá»›i Protocol Buffers hay `protobuf`. ÄÆ°á»£c phÃ¡t triá»ƒn bá»Ÿi Google Ä‘á»ƒ tuáº§n tá»± hoÃ¡ cÃ¡c dá»¯ liá»‡u cÃ³ cáº¥u trÃºc.

## Networking stack: `libp2p`

Má»™t trong cÃ¡c thÆ° viá»‡n phá»• biáº¿n vÃ  máº¡nh máº½ Ä‘Æ°á»£c sá»­ dá»¥ng bá»Ÿi cÃ¡c giáº£i phÃ¡p phÃ¢n tÃ¡n vÃ  blockchain rá»™ng rÃ£i Ä‘Ã³ lÃ  `libp2p`. `libp2p` táº­p há»£p cÃ¡c thÆ° viá»‡n vÃ  giao thá»©c khÃ¡c nhau Ä‘á»ƒ giÃºp ngÆ°á»i dÃ¹ng kiáº¿n táº¡o nÃªn há»‡ thá»‘ng máº¡ng vá»›i kháº£ nÄƒng má»Ÿ rá»™ng cao. `libp2p` Ä‘Æ°á»£c á»©ng dá»¥ng rá»™ng rÃ£i trong cÃ¡c há»‡ thá»‘ng phi táº­p trung. Váº­y vÃ¬ sao `libp2p` láº¡i cÃ³ tÃ­nh á»©ng dá»¥ng cao nhÆ° váº­y?

> MÃ¬nh váº«n cÃ²n nhá»› tá»« tráº£i nghiá»‡m cÃ¡ nhÃ¢n khi lÃ m dá»± Ã¡n cÃ³ chá»©c nÄƒng gá»i video call sá»­ dá»¥ng **WebRTC** thá»i Ä‘áº¡i há»c. VÃ¬ thiáº¿u kinh nghiá»‡m nÃªn Ä‘Ã³ lÃ  má»™t quÃ¡ trÃ¬nh cháº­t váº­t cá»‘ gáº¯ng giáº£i quyáº¿t tá»« váº¥n Ä‘á» má»™t liÃªn quan vá» Networking. NÃ o lÃ  _handshaking, signaling_ Ä‘áº¿n _STUN/TURN server_ vÃ  cÃ¡c váº¥n Ä‘á» liÃªn quan Ä‘áº¿n tÆ°á»Ÿng lá»­a.

Äá»‘i vá»›i má»™t há»‡ thá»‘ng phá»©c táº¡p _P2P (peer-to-peer)_ nhÆ° blockchain cÃ³ thá»ƒ lÃªn Ä‘áº¿n _1000_ node ngang hÃ ng thÃ¬ cÃ³ ráº¥t ráº¥t nhiá»u váº¥n Ä‘á» náº£y sinh. Blockchain cáº§n Ä‘Ã¡p á»©ng Ä‘Æ°á»£c nhu cáº§u phi táº­p trung toÃ n cáº§u, vÃ¬ váº­y, networking lÃ  má»™t trong nhá»¯ng váº¥n Ä‘á» cáº§n Ä‘Æ°á»£c Æ°u tiÃªn giáº£i quyáº¿t nháº¥t.

![libp2p stack](/static/images/polkadot/libp2p-stack.png)

`libp2p` Ä‘Æ°á»£c sá»­ dá»¥ng trong Ethereum,, IPFS vÃ  Polkadot bá»Ÿi cÃ¡c networking mÃ´ Ä‘un tÃ­ch há»£p dá»… dÃ ng. Báº¡n cÃ³ thá»ƒ hÃ¬nh dung `libp2p` cÅ©ng khÃ´ng khÃ¡c gÃ¬ FRAME system trong Substrate lÃ  máº¥y vá»›i táº­p há»£p nhiá»u Pallet khÃ¡c nhau nháº±m giáº£i quyáº¿t tá»«ng váº¥n Ä‘á» cá»¥ thá»ƒ.

Trong khuÃ´n khá»• bÃ i viáº¿t nÃ y, mÃ¬nh sáº½ khÃ´ng Ä‘Ã o quÃ¡ sau vá» `libp2p`, cÃ¡c báº¡n cÃ³ thá»ƒ Ä‘á»c thÃªm táº¡i Ä‘Ã¢y: [Introduction to libp2p - Proto School](https://proto.school/introduction-to-libp2p/01)

## CÆ¡ cháº¿ P2P cá»§a Substrate Node

Substrate sá»­ dá»¥ng core library `sc_network` Ä‘á»ƒ Ä‘á»‹nh vá»‹ vÃ  tÃ¬m kiáº¿m vá»›i cÃ¡c node ngang hÃ ng khÃ¡c trong cÃ¹ng máº¡ng lÆ°á»›i.

### Danh tÃ­nh vÃ  Ä‘á»‹a chá»‰ Node

Trong máº¡ng phi táº­p trung, má»—i node giá»¯ má»™t private key vÃ  má»™t public key. Trong Substrate, cÃ¡c key Ä‘Æ°á»£c dá»±a trÃªn Ed25519 curve, Ã¡p dá»¥ng cho cáº£ _Ethereum_ vÃ  _Solana_. Tá»« public key cá»§a má»™t node, ta cÃ³ thá»ƒ chuyá»ƒn hoÃ¡ sang danh tÃ­nh (_identity_) cá»§a node Ä‘Ã³.

Trong Substrate vÃ  libp2p, danh tÃ­nh cá»§a node Ä‘Æ°á»£c biá»ƒu diá»…n qua [_struct_ `sc_network::PeerId`](https://docs.rs/sc-network/latest/sc_network/struct.PeerId.html). Struct nÃ y bao gá»“m má»™t sá»‘ hÃ m phá»• biáº¿n mÃ  báº¡n cÃ³ thá»ƒ sáº½ sá»­ dá»¥ng trong quÃ¡ trÃ¬nh phÃ¡t triá»ƒn Substrate Node nhÆ° lÃ 

```rust
// Tá»« public key thÃ nh PeerId
pub fn from_public_key(key: &PublicKey) -> PeerId

// Tá»« bytes thÃ nh PeerId
pub fn from_bytes(data: &[u8]) -> Result<PeerId, Error>
```

Táº¥t cáº£ giao tiáº¿p trong máº¡ng lÆ°á»›i giá»¯a cÃ¡c nodes vá»›i nhau sá»­ dá»¥ng mÃ£ hoÃ¡ Ä‘Æ°á»£c **chuyá»ƒn hoÃ¡ tá»« key cá»§a cÃ¡c phÃ­a**. Äiá»u Ä‘Ã³ cÃ³ nghÄ©a lÃ  danh tÃ­nh cá»§a cÃ¡c node lÃ  khÃ´ng thá»ƒ bá»‹ lÃ m giáº£.

```rust
2023-11-28 22:27:24 Substrate Node Â  Â 
2023-11-28 22:27:24 âœŒï¸Â  version 4.0.0-dev-41ad4a6c9d7 Â  Â 
2023-11-28 22:27:24 â¤ï¸Â  by Substrate DevHub <https://github.com/substrate-developer-hub>, 2017-2023 Â  Â 
2023-11-28 22:27:24 ğŸ“‹ Chain specification: Development Â  Â 
2023-11-28 22:27:24 ğŸ·Â  Node name: high-jail-4418 Â  Â 
2023-11-28 22:27:24 ğŸ‘¤ Role: AUTHORITY Â  Â 
2023-11-28 22:27:24 ğŸ’¾ Database: RocksDb at /var/folders/tb/r5r120jx4c34f2wnhrv6hx000000gn/T/substrate5QtFRt/chains/dev/db/full Â  Â 
2023-11-28 22:27:24 ğŸ”¨ Initializing Genesis block/state (state: 0x92f9â€¦1aee, header-hash: 0x294aâ€¦709d) Â  Â 
2023-11-28 22:27:24 ğŸ‘´ Loading GRANDPA authority set from genesis on what appears to be first startup. Â  Â 
2023-11-28 22:27:24 Using default protocol ID "sup" because none is configured in the chain specs Â  Â 

// Danh tinhs cá»§a node, dÃ¡nh tÃ­nh nÃ y Ä‘Æ°á»£c chuyá»ƒn hoÃ¡ tá»« public key Ä‘á»‹nh trÆ°á»›c cá»§a node Ä‘Ã³.
2023-11-28 22:27:24 ğŸ·Â  Local node identity is: 12D3KooWLoe7Vi1nGqsNesx28464Qgsa9ydmwH1LY7aqPv7Qn6iF Â  Â 

2023-11-28 22:27:24 ğŸ’» Operating system: macos Â  Â 

2023-11-28 22:27:24 ğŸ’» CPU architecture: aarch64 Â  Â 

2023-11-28 22:27:24 ğŸ“¦ Highest known block at #0 Â  Â 

2023-11-28 22:27:24 ã€½ï¸ Prometheus exporter started at 127.0.0.1:9615
```

### CÆ¡ cháº¿ tÃ¬m node trong máº¡ng ngang hÃ ng cá»§a Substrate

ÄÆ°á»£c hiá»ƒu thÃªm vá» cÃ¡ch mÃ  cÃ¡c Substrate tÃ¬m cÃ¡c node ngang hÃ ng khÃ¡c trong cÃ¹ng má»™t máº¡ng lÆ°á»›i, báº¡n cÃ³ thá»ƒ xem qua tÃ i liá»‡u sau [Authorize Specific Nodes](https://docs.substrate.io/tutorials/build-a-blockchain/authorize-specific-nodes/) vá» viá»‡c cáº¥p quyá»n cho node Ä‘á»ƒ tham gia vÃ o máº¡ng lÆ°á»›i sá»­ dá»¥ng `node-authroization` pallet.

Äá»ƒ tÃ¬m kiáº¿m Ä‘Æ°á»£c cÃ¡c node trong cÃ¹ng máº¡ng lÆ°á»›i, danh tÃ­nh cá»§a node pháº£i Ä‘Æ°á»£c cáº¥p quyá»n vÃ  lÃ  má»™t pháº§n cá»§a máº¡ng lÆ°á»›i. Substrate cÃ³ 3 cÆ¡ cháº¿:

- Khai bÃ¡o danh tÃ­nh cá»§a node trong network qua Chain Specification (`chain_spec.rs`).
  Láº¥y vÃ­ dá»¥ vá» chain specification cá»§a `Local Testnet`

```rust
pub fn local_testnet_config() -> Result<ChainSpec, String> {
	let wasm_binary = WASM_BINARY.ok_or_else(|| "Development wasm not available".to_string())?;

	Ok(ChainSpec::from_genesis(
		// Name
		"Local Testnet",
		// ID
		"local_testnet",
		ChainType::Local,
		move || {
			// Khai bÃ¡o cÃ¡c accounts trong Network
			testnet_genesis(
				wasm_binary,
				// Initial PoA authorities
				vec![authority_keys_from_seed("Alice"), authority_keys_from_seed("Bob")],
				// Sudo account
				get_account_id_from_seed::<sr25519::Public>("Alice"),
				// Pre-funded accounts
				vec![
					get_account_id_from_seed::<sr25519::Public>("Alice"),
					get_account_id_from_seed::<sr25519::Public>("Bob"),
					get_account_id_from_seed::<sr25519::Public>("Charlie"),
					get_account_id_from_seed::<sr25519::Public>("Dave"),
					get_account_id_from_seed::<sr25519::Public>("Eve"),
					get_account_id_from_seed::<sr25519::Public>("Ferdie"),
					get_account_id_from_seed::<sr25519::Public>("Alice//stash"),
					get_account_id_from_seed::<sr25519::Public>("Bob//stash"),
					get_account_id_from_seed::<sr25519::Public>("Charlie//stash"),
					get_account_id_from_seed::<sr25519::Public>("Dave//stash"),
					get_account_id_from_seed::<sr25519::Public>("Eve//stash"),
					get_account_id_from_seed::<sr25519::Public>("Ferdie//stash"),
				],
```

- **Multicase DNS (mDNS)**: Truyá»n tin thÃ´ng qua giao thá»©c UDP (_UDP broadcasting_) Ä‘áº¿n toÃ n máº¡ng lÆ°á»›i, cÃ¡c node nháº­n Ä‘Æ°á»£c tÃ­n hiá»‡u cÃ³ thá»ƒ pháº£n há»“i láº¡i cÃ¹ng vá»›i danh tÃ­nh cá»§a nÃ³.
- **Kademlia random walk** (Hiá»‡n táº¡i mÃ¬nh chÆ°a nghiÃªn cá»©u quÃ¡ sÃ¢u vá» Kademlia nÃªn chÃºng ta sáº½ Ä‘Ã o sÃ¢u thÃªm vá» cÆ¡ cháº¿ nÃ y khi cÃ³ cÆ¡ há»™i)
